<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
  <title>Spotify Party</title>
  
  <script>
    // Redirection IMM√âDIATE apr√®s auth Spotify
    if (window.location.href.includes('/api/auth/callback?code=')) {
      console.log('üîç D√©tection callback Spotify');
      
      // Extraire le code de l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      
      if (code) {
        console.log('üìù Code re√ßu:', code);
        
        // Stocker le code temporairement
        sessionStorage.setItem('spotify_auth_code', code);
        
        // Rediriger IMM√âDIATEMENT vers l'app
        console.log('üîÑ Redirection vers /#/');
        window.location.href = '/#/';
      }
    }

    // Au chargement de la page, v√©rifier s'il y a un code √† traiter
    window.addEventListener('load', function() {
      const code = sessionStorage.getItem('spotify_auth_code');
      
      if (code) {
        console.log('üîÑ Traitement du code stock√©:', code);
        
        // Appeler l'API pour √©changer le code
        fetch(`/api/auth/callback?code=${code}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Erreur API: ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            console.log('‚úÖ Auth r√©ussie:', data);
            
            // Stocker les donn√©es
            localStorage.setItem('access_token', data.access_token);
            localStorage.setItem('user_id', data.user.id);
            localStorage.setItem('user_data', JSON.stringify(data.user));
            
            // Nettoyer le code temporaire
            sessionStorage.removeItem('spotify_auth_code');
            
            // Rediriger vers la page principale
            console.log('üè† Redirection vers /#/home');
            window.location.href = '/#/home';
          })
          .catch(error => {
            console.error('‚ùå Erreur auth:', error);
            sessionStorage.removeItem('spotify_auth_code');
            alert('Erreur d\'authentification: ' + error.message);
          });
      }
    });
  </script>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.png">
</head>
<body>
  <script src="main.dart.js" type="application/javascript"></script>
</body>
</html>